<!DOCTYPE html>
<html>
<head>
  <title>Club Attendance Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: auto; }
    #log { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Attendance Scanner</h1>
  <button onclick="manualAppend()">Test Append</button>
  <button onclick="handleAuthClick()">Authorize Google Sheets</button>
  <div id="reader"></div>
  <div id="log"></div>

  <script>
    const logDiv = document.getElementById('log');
    const SCANNED_IDS = new Set();

    function logScan(data) {
      if (SCANNED_IDS.has(data)) return;
      SCANNED_IDS.add(data);

      const timestamp = new Date().toISOString();
      const entry = `Scanned ID: ${data} | Time: ${timestamp}`;
      console.log(entry);
      logDiv.innerHTML = `<p>${entry}</p>` + logDiv.innerHTML;

      const values = [[1]];
      const body = { values };
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: '1C7MVH3J-U42HNT5yXNEGHrRa8lMp9HiEYJ9UD5fnS4w',
        range: 'Sheet1!A:B',
        valueInputOption: 'RAW',
        resource: body
      }).then((response) => {
        console.log(`${response.result.updates.updatedCells} cells appended.`);
      });
    }

    const scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: 250
      },
      (decodedText) => {
        logScan(decodedText);
      },
      (errorMessage) => {
        // ignore errors
      }
    ).catch(err => console.error("Camera start error:", err));

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn();
    }

    function initClient() {
      gapi.client.init({
        apiKey: 'AIzaSyADB87h0Lfjfzk5qX_ab7HPcJFMuvt-PJI',
        clientId: '353375855512-09nu021l1sf9t4m1v25v4jof4d6150lg.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      }).then(() => {
        console.log("GAPI client initialized.");
      });
    }
    function manualAppend() {
      const values = [[1]];
      const body = { values };
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: '1C7MVH3J-U42HNT5yXNEGHrRa8lMp9HiEYJ9UD5fnS4w',
        range: 'Sheet1!A:A',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: body
      }).then((response) => {
        console.log("Manual append success:", response);
      }).catch((error) => {
        console.error("Manual append failed:", error);
      });
  }

    gapi.load('client:auth2', initClient);
  </script>
</body>
</html>
