<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Club Attendance Scanner</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #scanner-ui { display: none; margin-top: 20px; }
    #reader { width: 300px; margin: auto; }
    #log { margin-top: 20px; }
    #manual-btn { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Attendance Scanner</h1>

  <!-- Google Sign-In button -->
  <div id="g_id_signin"></div>

  <!-- Scanner UI (hidden until authorized) -->
  <div id="scanner-ui">
    <button id="manual-btn" onclick="manualTest()">Manual Append Test</button>
    <div id="reader"></div>
    <div id="log"></div>
  </div>

  <script>
    const CLIENT_ID = '353375855512-09nu021l1sf9t4m1v25v4jof4d6150lg.apps.googleusercontent.com';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpc3BDq0UoF54rKl8MjqCd13yTEFv_hAWtwIYoD6cYPXy-AC7ekqGOO--PR2I7FpcJ/exec';
    const allowedEmails = [
      'jgdiers0205@gmail.com',
      'officer2@example.com',
      'officer3@example.com',
      'officer4@example.com',
      'officer5@example.com',
      'officer6@example.com'
    ];

    let idToken = '';
    const logDiv = document.getElementById('log');
    const SCANNED_IDS = new Set();

    // Callback after Google Sign-In
    function handleCredentialResponse(response) {
      console.log('handleCredentialResponse:', response);
      idToken = response.credential;
      try {
        const payload = JSON.parse(atob(idToken.split('.')[1]));
        console.log('ID Token payload:', payload);
        const email = payload.email;
        if (!allowedEmails.includes(email)) {
          alert('Access denied: ' + email);
          return;
        }
        // Hide login, show scanner UI
        document.getElementById('g_id_signin').style.display = 'none';
        document.getElementById('scanner-ui').style.display = 'block';
        startScanner();
      } catch (err) {
        console.error('Token decode error:', err);
      }
    }

    // Initialize Google Identity Services
    window.onload = () => {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: false
      });
      google.accounts.id.renderButton(
        document.getElementById('g_id_signin'),
        { theme: 'outline', size: 'large' }
      );
      // Removed auto prompt to avoid unwanted pop-ups
      // google.accounts.id.prompt();
    };

    function appendData(id, timestamp) {
      const params = new URLSearchParams({ id, timestamp, idToken });
      const url = `${SCRIPT_URL}?${params.toString()}`;
      fetch(url, { mode: 'no-cors' })
        .then(() => console.log('Data sent successfully'))
        .catch(err => console.error('Error sending data:', err));
    }

    function logScan(data) {
      if (SCANNED_IDS.has(data)) {
        console.log('Duplicate scan ignored:', data);
        return;
      }
      SCANNED_IDS.add(data);
      const timestamp = new Date().toISOString();
      const entry = `Scanned ID: ${data} | Time: ${timestamp}`;
      logDiv.innerHTML = `<p>${entry}</p>` + logDiv.innerHTML;
      appendData(data, timestamp);
    }

    function manualTest() {
      logScan('TEST');
    }

    function startScanner() {
      const scanner = new Html5Qrcode('reader');
      scanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        decodedText => logScan(decodedText),
        errorMessage => {}
      ).catch(err => console.error('Camera error:', err));
    }
  </script>
</body>
</html>
