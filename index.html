<!DOCTYPE html>
<html>
<head>
  <title>Club Attendance Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: auto; }
    #log { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Attendance Scanner</h1>
  <button onclick="handleAuthClick()">Authorize Google Sheets</button>
  <button onclick="manualAppendTest()">Manual Append Test</button>
  <div id="reader"></div>
  <div id="log"></div>

    <script>
    const logDiv = document.getElementById('log');
    const SCANNED_IDS = new Set();
    const SPREADSHEET_ID = '1C7MVH3J-U42HNT5yXNEGHrRa8lMp9HiEYJ9UD5fnS4w';
    const RANGE = 'Sheet1!A1';
  
    function appendRow(values) {
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: { values }
      }).then((response) => {
        console.log("Append success:", response);
      }).catch((error) => {
        console.error("Append failed:", error);
      });
    }
  
    function logScan(data) {
      if (SCANNED_IDS.has(data)) return;
      SCANNED_IDS.add(data);
  
      const timestamp = new Date().toISOString();
      const entry = `Scanned ID: ${data} | Time: ${timestamp}`;
      logDiv.innerHTML = `<p>${entry}</p>` + logDiv.innerHTML;
  
      appendRow([[data, timestamp]]);
    }
  
    function manualAppendTest() {
      appendRow([[1]]);
    }
  
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        console.log("Signed in");
      }).catch(err => {
        console.error("Sign-in failed:", err);
      });
    }
  
    function initClient() {
      gapi.client.init({
        apiKey: 'AIzaSyADB87h0Lfjfzk5qX_ab7HPcJFMuvt-PJI',
        clientId: '353375855512-09nu021l1sf9t4m1v25v4jof4d6150lg.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      }).then(() => {
        console.log("GAPI client initialized");
      });
    }
  
    gapi.load('client:auth2', initClient);
  
    const scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => logScan(decodedText),
      (errorMessage) => {} // ignore
    ).catch(err => console.error("Camera error:", err));
  </script>

</body>
</html>
