<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Club Attendance Scanner</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #scanner-ui { display: none; margin-top: 20px; }
    #reader { width: 300px; margin: auto; }
    #log { margin-top: 20px; max-height: 200px; overflow-y: auto; text-align: left; }
    #manual-container { margin-bottom: 10px; }
    #manual-id { padding: 5px; width: 200px; }
  </style>
</head>
<body>
  <h1>Attendance Scanner</h1>

  <!-- Google Sign-In button -->
  <div id="g_id_signin"></div>

  <!-- Scanner UI (hidden until authorized) -->
  <div id="scanner-ui">
    <div id="manual-container">
      <input type="text" id="manual-id" placeholder="Enter ID to append">
      <button id="manual-btn" onclick="manualInput()">Append ID</button>
    </div>
    <div id="reader"></div>
    <div id="log"></div>
  </div>

  <script>
    // Configuration
    const CLIENT_ID = '353375855512-09nu021l1sf9t4m1v25v4jof4d6150lg.apps.googleusercontent.com';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpc3BDq0UoF54rKl8MjqCd13yTEFv_hAWtwIYoD6cYPXy-AC7ekqGOO--PR2I7FpcJ/exec';
    const allowedEmails = [
      'jgdiers0205@gmail.com',
      'officer2@example.com',
      'officer3@example.com',
      'officer4@example.com',
      'officer5@example.com',
      'officer6@example.com'
    ];

    let idToken = '';
    const logDiv = document.getElementById('log');
    const SCANNED_IDS = new Set();

    // Google Sign-In callback
    function handleCredentialResponse(response) {
      idToken = response.credential;
      try {
        const payload = JSON.parse(atob(idToken.split('.')[1]));
        const email = payload.email;
        if (!allowedEmails.includes(email)) {
          alert('Access denied: ' + email);
          return;
        }
        // Show scanner UI
        document.getElementById('g_id_signin').style.display = 'none';
        document.getElementById('scanner-ui').style.display = 'block';
        startScanner();
      } catch (err) {
        console.error('Token decode error:', err);
      }
    }

    // Initialize Google Identity Services
    window.onload = () => {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: false
      });
      google.accounts.id.renderButton(
        document.getElementById('g_id_signin'),
        { theme: 'outline', size: 'large' }
      );
    };

    // Send data to Apps Script
    function appendData(id, timestamp) {
      const params = new URLSearchParams({ id, timestamp, idToken });
      const url = `${SCRIPT_URL}?${params.toString()}`;
      fetch(url, { mode: 'no-cors' })
        .then(() => console.log('Data sent:', id))
        .catch(err => console.error('Error sending data:', err));
    }

    // Log scanned or manual ID
    function logScan(id) {
      if (SCANNED_IDS.has(id)) return;
      SCANNED_IDS.add(id);
      const timestamp = new Date().toISOString();
      const entry = `ID: ${id} | ${timestamp}`;
      const p = document.createElement('p');
      p.textContent = entry;
      logDiv.prepend(p);
      appendData(id, timestamp);
    }

    // Handle manual input
    function manualInput() {
      const value = document.getElementById('manual-id').value.trim();
      if (!value) {
        alert('Please enter an ID');
        return;
      }
      logScan(value);
      document.getElementById('manual-id').value = '';
    }

    // Initialize and start scanner
    function startScanner() {
      const scanner = new Html5Qrcode('reader');
      scanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        decodedText => logScan(decodedText),
        () => {}
      ).catch(err => console.error('Camera error:', err));
    }
  </script>
</body>
</html>
